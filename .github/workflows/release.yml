name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  GO_VERSION: "1.24"
  PACKAGE_NAME: check-talos

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Format check
        run: |
          unformatted=$(gofmt -l $(git ls-files '*.go'))
          if [ -n "$unformatted" ]; then
            echo "The following files are not gofmt-ed:"
            echo "$unformatted"
            exit 1
          fi

      - name: Vet
        run: go vet ./...

      - name: Test
        run: go test -race -count=1 ./...

  build-and-release:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build binary
        run: make build

      - name: Install Debian packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            dh-make \
            debhelper \
            devscripts \
            fakeroot
      - name: Build .deb package
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME#v}"
          PKG_DIR="${PACKAGE_NAME}-${TAG}"

          mkdir "${PKG_DIR}"
          install -m 755 build/${PACKAGE_NAME} "${PKG_DIR}/${PACKAGE_NAME}"

          cd "${PKG_DIR}"

          export DEBEMAIL="ci@github.com"
          export DEBFULLNAME="GitHub Actions"

          dh_make --indep --createorig -y

          echo "${PACKAGE_NAME} /usr/lib/nagios/plugins" > debian/install

          debuild -us -uc
      - name: Extract changelog for release
        run: |
          TAG="${GITHUB_REF_NAME#v}"
          awk -v ver="${TAG}" '
            /^## \[/ {
              if (found) exit
              if (index($0, "[" ver "]")) { found=1; next }
            }
            found { print }
          ' CHANGELOG.md > release_notes.md

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME#v}"
          gh release create "${GITHUB_REF_NAME}" \
            --title "${PACKAGE_NAME} ${GITHUB_REF_NAME}" \
            --notes-file release_notes.md \
            "${PACKAGE_NAME}_${TAG}-1_all.deb"
